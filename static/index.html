<!DOCTYPE html>

<html>

<head>
	<meta charset="utf-8" />
	<title>Poker</title>
	<link rel="stylesheet" href="static/style.css" />
</head>

<body>
	<script src="static/drawFunctions.js"></script>
	<script src="static/drawCard.js"></script>
	<script src="static/drawTable.js"></script>
	<script src="static/playerCard.js"></script>
	<script src="static/player.js"></script>

	<div id="info">
		<div style="padding: 10px">
			<span>Status:</span>
			<span id="status">Disconnected</span>
		</div>
		<!--Game Info-->
		<div id="game_info" style="display: none; padding: 10px">
			<div>
				<span>Table Name:</span>
				<span id="table_name"></span>
			</div>

			<div>
				<span><input type="checkbox" id="sitoutbtn" name="sitoutbtn" value="sitout" /></span>
				<span>Sit Out</span>
			</div>

			<div style="padding-top: 10px">
				<button class="button" onclick="leaveTable()">Leave Table</button>
			</div>
		</div>

		<!--Lobby Menu-->
		<div id="lobby_menu" style="display: block; margin: 30px; padding: 10px; background: rgba(50, 50, 50, 0.7)">
			<!--Player Info-->
			<div>
				<span><input type="text" id="playerName" /></span>
				<span>
					<button class="button" onclick="setPlayerName()">Set Name</button>
				</span>
			</div>

			<div class="row">
				<!--Games List-->
				<div class="column">
					<h1>Join Table</h1>
					<span><input type="text" id="tableId" /></span>
					<span>
						<button class="button" onclick="joinTable()">Join Table</button>
					</span>
					<h3>Public Tables</h3>
					<button class="button" onclick="listPublicTable()">
						Refresh Public Games
					</button>
					<div id="publicTableList" style="overflow: scroll; margin: 20px;">

					</div>
				</div>
				<!--Create Game-->
				<div class="column">
					<h1>Create Table</h1>
					<span>Max number of players:</span>
					<span id="player_limit_value">9</span>
					<div class="slidecontainer" style="margin-bottom: 20px;">
						<input type="range" min="2" max="9" value="9" class="slider" id="player_limit_slider" />
					</div>

					<span>
						Number of bots:
					</span>
					<span id="number_of_bots_value">0</span>
					<div class="slidecontainer" style="margin-bottom: 20px;">
						<input type="range" min="0" max="8" value="0" class="slider" id="number_of_bots_slider" />
					</div>

					<table style="margin-bottom: 20px;">
						<tr>
							<td style="padding-right: 20px;">
								Small Blind:
							</td>
							<td>
								<input type="text" value="4" id="small_blind_value" />

							</td>
						</tr>
						<tr>
							<td style="padding-right: 20px;">
								Big Blind:
							</td>
							<td>
								<input type="text" value="8" id="big_blind_value" />
							</td>
						</tr>
						<tr>
							<td style="padding-right: 20px;">
								Starting Stack:
							</td>
							<td>
								<input type="text" value="1000" id="starting_stack_value" />
							</td>
						</tr>
						<tr>
							<td style="padding-right: 20px;">
								Password:
							</td>
							<td>
								<input type="password" id="password" />
							</td>
						</tr>
					</table>

					<div style="margin-bottom: 20px;">
						Leave password blank if you want the game to be public.
					</div>

					<button class="button" onclick="createTable()">Create Table</button>
				</div>
			</div>
		</div>
	</div>

	<div class="main">
		<div class="table">
			<canvas id="pokerTable" width="1200" height="720"> </canvas>
		</div>
		<div id="table_controls" class="row" style="display: none; margin: 10px">
			<div class="column">
				<div id="log"></div>

				<form id="chatform">
					<div style="display: flex; flex-direction: row">
						<input type="text" id="text" />
						<input type="submit" class="button" style="margin-left: 50px; float: right; width: 250px"
							id="send" onclick="sendMessage()" value="Send Message" />
					</div>
				</form>
			</div>
			<div class="column">
				<div style="
							margin-left: 10px;
							display: flex;
							flex-direction: row;
							width: 100%;
						">
					<div style="width: 100px">Bet Size:</div>
					<div class="slidecontainer">
						<input type="range" min="1" max="100" value="1" class="slider" id="betSizeSlider" />
					</div>
					<div style="margin-left: 10px; margin-bottom: 20px">
						<input type="text" style="width: 50px" id="betSize" />
					</div>
				</div>
				<div style="
							margin-left: 10px;
							display: flex;
							flex-direction: row;
							width: 100%;
						">
					<button class="button" style="flex: 0 50%" onclick="playerAction('fold')">
						Fold
					</button>
					<button class="button" style="flex: 0 50%" onclick="playerAction('check')">
						Check
					</button>
					<button class="button" style="flex: 0 50%" onclick="playerAction('call')">
						Call
					</button>
					<button class="button" style="flex: 0 50%" onclick="playerAction('bet')">
						Bet
					</button>
				</div>
			</div>
		</div>
	</div>

	<hr />

	<script>
		/** @type {WebSocket | null} */
		var socket = null;

		// Get canvas and context
		var canvas = document.getElementById("pokerTable");
		var context = canvas.getContext("2d");
		//context.font = "20px Georgia";

		var width = canvas.width;
		var height = canvas.height;

		let lastGameState = null;

		const $status = document.querySelector("#status");
		const $lobbyMenu = document.getElementById("lobby_menu");

		// Create Game
		const $playerLimitSlider = document.getElementById("player_limit_slider");
		const $playerLimitValue = document.getElementById("player_limit_value");
		const $botNumberSlider = document.getElementById("number_of_bots_slider");
		const $botNumberValue = document.getElementById("number_of_bots_value");
		const $smallBlindValue = document.getElementById("small_blind_value");
		const $bigBlindValue = document.getElementById("big_blind_value");
		const $startingStackValue = document.getElementById("starting_stack_value");
		const $password = document.getElementById("password");

		const $publicTableList = document.getElementById("publicTableList");

		const $gameMenu = document.getElementById("game_info");
		const $sitoutbtn = document.getElementById("sitoutbtn");
		const $log = document.querySelector("#log");
		const $form = document.querySelector("#chatform");
		const $input = document.getElementById("text");
		const $playerName = document.getElementById("playerName");
		const $tableId = document.getElementById("tableId");
		const $tableName = document.getElementById("table_name");
		const $tableControls = document.getElementById("table_controls");
		const $betSlider = document.getElementById("betSizeSlider");
		const $betSize = document.getElementById("betSize");

		$betSize.value = $betSlider.value;


		// this gives us the position of UI for a given MAPPED index
		// (e.g. the main player always maps to index 0)
		const mappedIndexToPlayerPosition = {
			0: [width / 2, height - 170],
			1: [280, height - 170],
			2: [100, height - 330],
			3: [100, 150],
			4: [width / 3 + 20, 20],
			5: [(2 * width) / 3, 20],
			6: [width - 100, 150],
			7: [width - 100, height - 330],
			8: [width - 280, height - 170],
		};

		const mappedIndexToPlayerChipPosition = {
			0: [width / 2 - 40, height - 220],
			1: [350, height - 220],
			2: [220, height - 320],
			3: [250, 300],
			4: [width / 3, 200],
			5: [(2 * width) / 3 - 30, 200],
			6: [width - 350, 300],
			7: [width - 320, height - 320],
			8: [width - 350, height - 220],
		};

		const mappedIndexToButtonPosition = {
			0: [width / 2 + 80, height - 180],
			1: [360, height - 180],
			2: [220, height - 270],
			3: [220, 250],
			4: [width / 3 - 60, 180],
			5: [(2 * width) / 3 - 80, 180],
			6: [width - 220, 250],
			7: [width - 220, height - 270],
			8: [width - 360, height - 180],
		};

		function updateBetSlider(gameState) {
			let yourIndex = gameState.your_index;
			let player = gameState.players[yourIndex];

			let minBet = 0;
			let maxBet = 0;

			if (player) {
				maxBet = player.money;
			}

			if (gameState.street == "preflop") {
				minBet = 2 * gameState.big_blind;
			} else {
				minBet = gameState.current_bet;
			}

			$betSlider.min = minBet;
			$betSlider.value = minBet;
			$betSlider.max = maxBet;

			$betSize.value = minBet;
		}

		function drawEverything(gameState) {
			// this is called after every change of state to re-render the entire UI.
			drawTable(context, width, height); // Draws the background and the table

			for (let i = 0; i < gameState.max_players; i++) {
				let playerState = gameState.players[i];

				if (playerState == null) {
					continue;
				}

				let mapped_index = (playerState.index - gameState.your_index + 9) % 9;
				// Get player position (x, y)
				let position = mappedIndexToPlayerPosition[mapped_index];
				let chip_position = mappedIndexToPlayerChipPosition[mapped_index];
				// Draw player
				let is_players_turn_to_act = gameState.index_to_act == playerState.index;

				let street_contributions = 0;

				if (gameState.street == "preflop") {
					street_contributions = playerState.preflop_cont;
				} else if (gameState.street == "flop") {
					street_contributions = playerState.flop_cont;
				} else if (gameState.street == "turn") {
					street_contributions = playerState.turn_cont;
				} else if (gameState.street == "river") {
					street_contributions = playerState.river_cont;
				}

				let player = new Player({
					name: playerState.player_name,
					index: playerState.index,
					money: playerState.money,
					action: playerState.last_action,
					is_players_turn_to_act: is_players_turn_to_act,
					street_contributions: street_contributions,
					is_active: playerState.is_active
				});

				// If this is the player then show the player their cards
				if ("hole_cards" in gameState &&
					gameState.hole_cards != null &&
					playerState.index == gameState.your_index) {
					let cards = gameState.hole_cards;

					var chars = cards.split("");
					player.giveCards(
						new PlayerCard(true, chars[0], chars[1]),
						new PlayerCard(true, chars[2], chars[3])
					);
				}

				player.draw(context, position);
				// Draw player chips
				player.drawChips(context, chip_position);

				if (gameState.button_idx == playerState.index) {
					// Draw Button
					let btn_position = mappedIndexToButtonPosition[mapped_index];
					context.fillStyle = "white";
					context.strokeStyle = "black";

					context.beginPath();
					context.arc(
						btn_position[0],
						btn_position[1] + 2,
						10,
						0,
						Math.PI * 2,
						true
					);
					context.fill();
					context.stroke();

					context.beginPath();
					context.arc(
						btn_position[0],
						btn_position[1],
						10,
						0,
						Math.PI * 2,
						true
					);
					context.fill();
					context.stroke();
				}
			}

			// table cards
			if ("flop" in gameState) {
				const chars = gameState.flop.split("");
				drawFrontCard(
					context,
					width / 3 + 50,
					height / 2 - 50,
					chars[0],
					chars[1]
				);
				drawFrontCard(
					context,
					width / 3 + 110,
					height / 2 - 50,
					chars[2],
					chars[3]
				);
				drawFrontCard(
					context,
					width / 3 + 170,
					height / 2 - 50,
					chars[4],
					chars[5]
				);
			}
			if ("turn" in gameState) {
				const chars = gameState.turn.split("");
				drawFrontCard(
					context,
					width / 3 + 230,
					height / 2 - 50,
					chars[0],
					chars[1]
				);
			}
			if ("river" in gameState) {
				const chars = gameState.river.split("");
				drawFrontCard(
					context,
					width / 3 + 290,
					height / 2 - 50,
					chars[0],
					chars[1]
				);
			}

			// Draw pots
			if ("pots" in gameState) {
				context.font = "bold 18px arial";
				context.textAlign = "start";
				context.fillStyle = "white";
				context.fillText("Pot(s): " + gameState.pots, width / 2 - 40, height / 2 + 80);
			}

			if ("current_bet" in gameState) {
				context.font = "bold 18px arial";
				context.textAlign = "start";
				context.fillStyle = "white";
				context.fillText(
					"Current bet: " + gameState.current_bet,
					width / 2 - 40,
					height / 2 + 110
				);
			}
		}

		function log(msg, type = "status") {
			console.log(msg);
			$log.innerHTML += `<p class="msg msg--${type}">${msg}</p>`;
			$log.scrollTop += 1000;
		}

		function showTable() {
			// Show Table
			$gameMenu.style.display = "block";
			$tableControls.style.display = "block";
			$lobbyMenu.style.display = "none";
		}

		function showLobby() {
			// Show Table
			$gameMenu.style.display = "none";
			$tableControls.style.display = "none";
			$lobbyMenu.style.display = "block";

			lastGameState = null;
		}

		function connect() {
			disconnect();

			const { location } = window;

			const proto = location.protocol.startsWith("https") ? "wss" : "ws";
			const wsUri = `${proto}://${location.host}/ws`;

			log("Connecting...");
			socket = new WebSocket(wsUri);

			socket.onopen = () => {
				log("Connected");
				updateConnectionStatus();
			};

			socket.onmessage = (ev) => {
				var msg;
				try {
					msg = JSON.parse(ev.data);
				} catch { }
				if (msg != null) {
					console.log("hello: " + JSON.stringify(msg));
					if (msg.msg_type == "game_state") {
						lastGameState = msg;
						updateBetSlider(msg);
						drawEverything(msg);
					} else if (msg.msg_type == "joined_game") {
						showTable();
						$tableName.innerHTML = msg.table_name;
						log(ev.data, "message");
					} else if (msg.msg_type == "new_hand") {
						// Show Table
						showTable();
						log("\n\nPlaying hand " + msg.hand_num, "message");
					} else if (msg.msg_type == "player_action") {
					} else if (msg.msg_type == "player_info") {
					} else if (msg.msg_type == "prompt") {
						log(msg.prompt, "message");
					} else if (msg.msg_type == "hole_cards") {
					} else if (msg.msg_type == "flop") {
						log(ev.data, "message");
					} else if (msg.msg_type == "turn") {
						log(ev.data, "message");
					} else if (msg.msg_type == "river") {
						log(ev.data, "message");
					} else if (msg.msg_type == "player_to_act") {
					} else if (msg.msg_type == "paying_out") {
						if (msg.is_showdown) {
							log("========= SHOWDOWN =========")
						} else {
							log("======== Ending before showdown =======")
						}
						let output1 = ("paying out " + msg.payout + " to " +
							msg.player_name + ", with hole cards = " + msg.hole_cards)
						log(output1, "message");
						let output2 = "hand result = " + msg.hand_result
						log(output2, "message");
					} else if (msg.msg_type == "left_game") {
						// Clear game info
						showLobby();
						drawTable(context, width, height);
						// Show Lobby
						$gameMenu.style.display = "none";
						//$tableControls.style.display = "none";
						$lobbyMenu.style.display = "block";
						// have this log for now just for clarity. if the UI is more clear wont need?
						log("You have left the game and are in the lobby", "message")
					} else if (msg.msg_type == "created_game") {
						showTable();
					} else if (msg.msg_type == "name_changed") {
						let output = "You have changed your name to " + msg.new_name;
						log(output, "message");
					} else if (msg.msg_type == "chat") {
						let output = msg.player_name + ": " + msg.text
						log(output, "message");
					} else if (msg.msg_type == "tables_list") {
						let tables = "";
						for (let table of msg.tables) {
							tables += "<p>" + table + "</p>";
						}
						$publicTableList.innerHTML = tables;
						log(ev.data, "message");
					} else if (msg.msg_type == "error") {
						alert(msg.error + ": " + msg.reason);
						log(msg.error + ": " + msg.reason, "message");
					} else if (msg.msg_type == "help_message") {
						log("Available admin commands:", "message");
						for (const cmd of msg.commands) {
							log(cmd, "message");
						}
					} else if (msg.msg_type == "admin_success") {
						log(msg.msg_type + ": " + msg.text, "message");
					} else {
						log("We are not handling this message properly!", "message");
					}
				} else {
					log("SHOULD NOT BE ANY OF THESE", "message")
					log(ev.data, "message");
				}
			};

			socket.onclose = () => {
				log("Disconnected");
				socket = null;
				updateConnectionStatus();
			};
		}

		function disconnect() {
			if (socket) {
				log("Disconnecting...");
				socket.close();
				socket = null;

				updateConnectionStatus();
			}
		}

		function updateConnectionStatus() {
			if (socket) {
				$status.style.backgroundColor = "transparent";
				$status.style.color = "#55ff55";
				$status.textContent = `Connected`;
				$input.focus();
			} else {
				$status.style.backgroundColor = "transparent";
				$status.style.color = "#ff5555";
				$status.textContent = "Disconnected";
			}
		}

		function setPlayerName() {
			var msg = {}; // build the json to send
			msg["msg_type"] = "name";
			msg["player_name"] = $playerName.value;
			socket.send(JSON.stringify(msg));
		}

		function joinTable() {
			var msg = {}; // build the json to send
			msg["msg_type"] = "join";
			msg["table_name"] = $tableId.value;
			msg["password"] = "123";
			socket.send(JSON.stringify(msg));
		}

		function listPublicTable() {
			var msg = {}; // build the json to send
			msg["msg_type"] = "list";
			socket.send(JSON.stringify(msg));
		}

		function createTable() {
			var msg = {}; // build the json to send
			msg["msg_type"] = "create";
			msg["max_players"] = parseInt($playerLimitSlider.value);
			msg["num_bots"] = parseInt($botNumberSlider.value);
			msg["small_blind"] = parseInt($smallBlindValue.value);
			msg["big_blind"] = parseInt($bigBlindValue.value);
			msg["buy_in"] = parseInt($startingStackValue.value);

			if ($password.value.length > 0) {
				msg["password"] = $password.value;
			}
			//log("Sending: " + JSON.stringify(msg));
			socket.send(JSON.stringify(msg));
		}

		function playerAction(action) {
			var msg = {}; // build the json to send
			msg["msg_type"] = "player_action";
			msg["action"] = action;

			if (action == "bet") {
				msg["amount"] = $betSize.value;
			}

			//log("Sending: " + JSON.stringify(msg));
			socket.send(JSON.stringify(msg));
		}

		function leaveTable() {
			showLobby();

			var msg = {}; // build the json to send

			msg["msg_type"] = "leave";

			log("Sending: " + JSON.stringify(msg));
			socket.send(JSON.stringify(msg));
		}

		function sendMessage() {
			var msg = {}; // build the json to send

			// first check if it starts with an admin command attempt
			if ($input.value.startsWith("/small_blind")) {
				msg["msg_type"] = "admin_command";
				const [_, value] = $input.value.split(" ");
				msg["admin_command"] = "small_blind";
				msg["small_blind"] = value;

			}
			else if ($input.value.startsWith("/big_blind")) {
				msg["msg_type"] = "admin_command";
				const [_, value] = $input.value.split(" ");
				msg["admin_command"] = "big_blind";
				msg["big_blind"] = value;

			}
			else if ($input.value.startsWith("/buy_in")) {
				msg["msg_type"] = "admin_command";
				msg["admin_command"] = "buy_in";
				msg["buy_in"] = value;
			}
			else if ($input.value.startsWith("/password")) {
				msg["msg_type"] = "admin_command";
				const [_, value] = $input.value.split(" ");
				msg["admin_command"] = "password";
				msg["password"] = value;
			}
			else if ($input.value.startsWith("/add_bot")) {
				msg["msg_type"] = "admin_command";
				msg["admin_command"] = "add_bot";
			}
			else if ($input.value.startsWith("/remove_bot")) {
				msg["msg_type"] = "admin_command";
				msg["admin_command"] = "remove_bot";
			}
			else if ($input.value.startsWith("/restart")) {
				msg["msg_type"] = "admin_command";
				msg["admin_command"] = "restart";
			}
			else if ($input.value.startsWith("/help")) {
				msg["msg_type"] = "help";
			}
			else {
				msg["msg_type"] = "chat";
				msg["text"] = $input.value;
			}

			log("Sending: " + JSON.stringify(msg));
			if (msg["msg_type"] == "admin_command") {
				log("admin commands are handled at the end of the current hand");
			}
			socket.send(JSON.stringify(msg));

			$input.value = "";
			$input.focus();
		}

		$form.addEventListener("submit", (ev) => {
			// this remnant from the template is needed for the app not to crash
			// I guess it prevents the form from doing something?
			ev.preventDefault();
		});

		$betSlider.oninput = function () {
			$betSize.value = this.value;
		};

		$playerLimitSlider.oninput = function () {
			$playerLimitValue.innerHTML = this.value;
		}

		$botNumberSlider.oninput = function () {
			$botNumberValue.innerHTML = this.value;
		}

		$sitoutbtn.oninput = function () {
			var msg = {}; // build the json to send
			if (this.checked) {
				msg["msg_type"] = "sitout";
			} else {
				msg["msg_type"] = "imback";
			}

			log("Sending: " + JSON.stringify(msg));
			socket.send(JSON.stringify(msg));
		};

		window.onresize = function (event) {
			let newWidth = window.innerWidth;
			let newHeight = window.innerHeight - 250;

			let ratio = 2.3;
			let newRatio = newWidth / newHeight;

			if (newRatio > ratio) {
				canvas.style = 'height: ' + (window.innerHeight - 250).toString() + 'px';
			} else {
				canvas.style = 'width: 100%';
			}

			if (lastGameState) {
				drawEverything(lastGameState);
			} else {
				drawTable(context, width, height);
			}
		}


		connect();
		updateConnectionStatus();

		drawTable(context, width, height);
	</script>
</body>

</html>
